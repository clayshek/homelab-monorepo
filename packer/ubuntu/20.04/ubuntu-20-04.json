{
    "description": "Build Ubuntu 20.04.2 Proxmox template",
    "variables": {
        "iso_filename": "local:iso/ubuntu-20.04.2-live-server-amd64.iso",
        "iso_checksum": "d1f2bf834bbe9bb43faf16f9be992a6f3935e65be0edece1dee2aa6eb1767423",
        "template_name": "template-ubuntu-20-04-2",
        "template_description": "Ubuntu 20.04.2 x86_64 template generated by Packer on {{ isotime \"2006-01-02T15:04:05Z\" }}. Username: packer",
        "vm_enable_qemu_agent": "true",
        "vm_memory": "2048",
        "vm_cores": "2",
        "vm_sockets": "2",
        "vm_cpu_type": "host",
        "vm_network_adapter_model": "virtio",
        "vm_network_adapter_bridge": "vmbr0",
        "vm_scsi_controller": "virtio-scsi-pci",
        "vm_disk_size": "50G",
        "vm_disk_type": "scsi",
        "vm_disk_format": "qcow2",
        "vm_storage_pool": "vm-store",
        "vm_storage_pool_type": "directory",
        "ssh_username": "ubuntu",
        "ssh_password": "ubuntu"
    },

    "sensitive-variables": ["proxmox_password"],

    "builders": [
        {
            "type": "proxmox",
            "proxmox_url": "{{user `proxmox_api_url`}}",
            "insecure_skip_tls_verify": true,
            "username": "{{user `proxmox_username`}}",
            "password": "{{user `proxmox_password`}}",
            "node": "{{user `proxmox_node`}}",
            "iso_file": "{{user `iso_filename`}}",
            "iso_checksum": "{{user `iso_checksum`}}",
            "qemu_agent": "{{user `vm_enable_qemu_agent`}}",
            "memory": "{{user `vm_memory`}}",
            "cores": "{{user `vm_cores`}}",
            "sockets": "{{user `vm_sockets`}}",
            "cpu_type": "{{user `vm_cpu_type`}}",
            "network_adapters": [
              {
                "bridge": "{{user `vm_network_adapter_bridge`}}",
                "model": "{{user `vm_network_adapter_model`}}"
              }
            ],
            "scsi_controller": "{{user `vm_scsi_controller`}}",
            "disks": [
              {
                "type": "{{user `vm_disk_type`}}",
                "disk_size": "{{user `vm_disk_size`}}",
                "format": "{{user `vm_disk_format`}}",
                "storage_pool": "{{user `vm_storage_pool`}}",
                "storage_pool_type": "{{user `vm_storage_pool_type`}}"
              }
            ],
      
            "http_directory": "ubuntu/20.04/config",
            "boot_wait": "2s",
            "boot_command": [
              "<esc><wait><esc><wait><f6><wait><esc><wait>",
              "<bs><bs><bs><bs><bs>",
              "autoinstall ds=nocloud-net;s=http://{{ .HTTPIP }}:{{ .HTTPPort }}/ ",
              "--- <enter>"
            ],
      
            "ssh_username": "{{user `ssh_username`}}",
            "ssh_password": "{{user `ssh_password`}}",
            "ssh_timeout": "20m",

            "unmount_iso": true,
            "template_name": "{{user `template_name`}}",
            "template_description": "{{user `template_description`}}",
            "cloud_init": true,
            "cloud_init_storage_pool": "{{user `vm_storage_pool`}}"
          }
    ],

    "provisioners": [
        {
            "type": "shell",
            "inline": [
                "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init...'; sleep 1; done"
             ]        
        },
        {
            "type": "shell",
            "script": "ubuntu/cleanup.sh"
        }
    ]    
  
  }
