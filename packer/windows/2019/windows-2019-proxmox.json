{
    "description": "Build Windows Server 2019 Proxmox template",
    "variables": {
        "os_iso_filename": "local:iso/17763.737.190906-2324.rs5_release_svc_refresh_SERVER_EVAL_x64FRE_en-us_1.iso",
        "virtio_iso_filename": "local:iso/virtio-win-0.1.190.iso",
        "virtio_iso_url": "https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.190-1/virtio-win.iso",
        "proxmox_iso_storage_pool": "local",
        "unattend_iso_checksum": "c9b5d7ae74de10032b307b508d11f721",
        "template_name": "tpl-win2019-DC",
        "template_description": "Windows Server 2019 Datacenter template generated by Packer on {{ isotime \"2006-01-02T15:04:05Z\" }}.",
        "vm_enable_qemu_agent": "true",
        "vm_hostname": "server2019-DC-tpl",
        "vm_os_type": "win10",
        "vm_memory": "2048",
        "vm_cores": "2",
        "vm_sockets": "2",
        "vm_cpu_type": "host",
        "vm_network_adapter_model": "virtio",
        "vm_network_adapter_bridge": "vmbr0",
        "vm_scsi_controller": "virtio-scsi-pci",
        "vm_disk_size": "50G",
        "vm_disk_type": "scsi",
        "vm_disk_format": "qcow2",
        "vm_storage_pool": "vm-store",
        "vm_storage_pool_type": "directory",
        "winrm_username": "Administrator",
        "winrm_password": "packer"
    },

    "sensitive-variables": ["proxmox_password"],

    "builders": [
        {
            "type": "proxmox",
            "proxmox_url": "{{user `proxmox_api_url`}}",
            "insecure_skip_tls_verify": true,
            "username": "{{user `proxmox_username`}}",
            "password": "{{user `proxmox_password`}}",
            "node": "{{user `proxmox_node`}}",
            "iso_file": "{{user `os_iso_filename`}}",
            "os": "{{user `vm_os_type`}}",
            "qemu_agent": "{{user `vm_enable_qemu_agent`}}",
            "memory": "{{user `vm_memory`}}",
            "cores": "{{user `vm_cores`}}",
            "sockets": "{{user `vm_sockets`}}",
            "cpu_type": "{{user `vm_cpu_type`}}",
            "network_adapters": [
              {
                "bridge": "{{user `vm_network_adapter_bridge`}}",
                "model": "{{user `vm_network_adapter_model`}}"
              }
            ],
            "scsi_controller": "{{user `vm_scsi_controller`}}",
            "disks": [
              {
                "type": "{{user `vm_disk_type`}}",
                "disk_size": "{{user `vm_disk_size`}}",
                "format": "{{user `vm_disk_format`}}",
                "storage_pool": "{{user `vm_storage_pool`}}",
                "storage_pool_type": "{{user `vm_storage_pool_type`}}"
              }
            ],      
            "additional_iso_files": [
              {
                "device": "ide0",
                "iso_file": "{{user `virtio_iso_filename`}}",
                "unmount": true,
                "iso_checksum": "none"
              },
              {
                "device": "ide1",
                "iso_file": "local:iso/unattend.iso",
                "unmount": true,
                "iso_checksum": "none"
              }
            ],
            "communicator": "winrm",
            "winrm_username": "{{user `winrm_username`}}",
            "winrm_password": "{{user `winrm_password`}}",
            "winrm_timeout": "180m",
            "winrm_use_ssl": true,
            "winrm_insecure": true,

            "unmount_iso": true,
            "template_name": "{{user `template_name`}}",
            "template_description": "{{user `template_description`}}",
            "cloud_init": true,
            "cloud_init_storage_pool": "{{user `vm_storage_pool`}}"
          }
    ],

    "provisioners": [
      {
          "type": "file",
          "source": "windows/2019/cloudbase_init_templates/cloudbase-init.conf",
          "destination": "C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\conf\\cloudbase-init.conf"
      },
      {
        "type": "file",
        "source": "windows/2019/cloudbase_init_templates/cloudbase-init-unattend.conf",
        "destination": "C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\conf\\cloudbase-init-unattend.conf"
      },      
      {
          "type": "windows-shell",
          "inline": [
            "cd \"C:\\Program Files\\Cloudbase Solutions\\Cloudbase-Init\\conf\"",
            "c:\\Windows\\System32\\Sysprep\\sysprep.exe /quiet /generalize /oobe /unattend:Unattend.xml"
          ]
      }
  ]   

  }